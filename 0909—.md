
Проблема не в “новых переменных”, а в кластерных правах.
Kiali стартует, но его service account system:serviceaccount:kiali:kiali не может читать ресурсы во всех namespace (list *v1.Services cluster-scope). В логе прямо сказано, что нет ClusterRole(ов) kiali и kiali-viewer, поэтому кеш останавливается.

Ниже — быстрый чек-лист диагностики и два пути фикса: «правильно через Helm/ArgoCD» и «экстренно вручную».

⸻

1) Проверка (1 мин)

# Ищем кластерные роли/биндинги для Kiali
kubectl get clusterrole,clusterrolebinding | grep -E '\bkiali(-viewer)?\b' || echo "нет"

# Смотрим, какие значения реально применены в релизе Helm
helm -n kiali get values <RELEASE> --all | yq '.rbac.create, .deployment.cluster_wide_access, .service_account.create, .service_account.name'

Ожидаемо для server-chart без оператора:
	•	rbac.create: true
	•	deployment.cluster_wide_access: true
	•	SA существует (обычно kiali)

Если clusterrole/clusterrolebinding нет — Kiali SA не получит нужных прав → лог как на фото.

⸻

2) Причины, почему кластерные роли не создались
	1.	rbac.create: false в values.yaml (или в другом overlay).
	2.	deployment.cluster_wide_access: false — тогда chart не создаёт cluster-scope RBAC.
	3.	ArgoCD (или ваш CI SA) не имеет права создавать ClusterRole/ClusterRoleBinding → синк прошёл частично, кластерные объекты отфутболены «forbidden».
	4.	Релиз/имя изменили, а вы смотрите не те ресурсы (но лог показывает SA kiali:kiali, значит всё довольно стандартно).

⸻

3) Правильный фикс через Helm/ArgoCD

A. Значения Helm (обязательно)

В вашем values.yaml (тот, что применяет ArgoCD) должно быть так:

deployment:
  cluster_wide_access: true

rbac:
  create: true

service_account:
  create: true
  name: kiali   # либо ваше имя, но оно должно совпадать с SA, на котором стартует под

Коммит → argocd app sync <APP>.

B. Дайте ArgoCD право создавать кластерные RBAC

Если синк всё равно не создаёт ClusterRole/Binding — значит, у SA контроллера ArgoCD нет прав на кластерные RBAC. Самый короткий способ (выберите один):

Вариант 1 (минимальные права для RBAC-ресурсов):

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-kiali-rbac-manager
rules:
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["clusterroles","clusterrolebindings"]
  verbs: ["get","list","watch","create","update","patch","delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-kiali-rbac-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-kiali-rbac-manager
subjects:
- kind: ServiceAccount
  name: argocd-application-controller   # или ваш SA контроллера
  namespace: argocd                    # ваш ns ArgoCD

Вариант 2 (грубовато, но быстро): дать контроллеру cluster-admin (на тест/канарейку).

После этого повторите sync — Helm сам создаст ClusterRole kiali, ClusterRole kiali-viewer и их bindings.

⸻

4) Экстренный обходной путь (если права ArgoCD менять нельзя прямо сейчас)

Делайте это только как временную меру, а затем перенесите в Git/Helm.

	1.	Запретите Helm создавать RBAC, чтобы не конфликтовало:

rbac:
  create: false

	2.	Примените кластерные роли/биндинги вручную (минимально необходимые для Kiali-SA и viewer-ролей):

# -------- Kiali (для service account) --------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kiali
rules:
- apiGroups: [""]
  resources: ["pods","services","endpoints","replicationcontrollers","namespaces","configmaps"]
  verbs: ["get","list","watch"]
- apiGroups: ["apps","extensions"]
  resources: ["deployments","replicasets","statefulsets","daemonsets"]
  verbs: ["get","list","watch"]
- apiGroups: ["batch"]
  resources: ["jobs","cronjobs"]
  verbs: ["get","list","watch"]
- apiGroups: ["autoscaling"]
  resources: ["horizontalpodautoscalers"]
  verbs: ["get","list","watch"]
- apiGroups: ["networking.istio.io","security.istio.io","telemetry.istio.io","gateway.networking.k8s.io"]
  resources: ["*"]
  verbs: ["get","list","watch"]
- apiGroups: ["networking.k8s.io","discovery.k8s.io","policy"]
  resources: ["*"]
  verbs: ["get","list","watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kiali
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kiali
subjects:
- kind: ServiceAccount
  name: kiali
  namespace: kiali

# -------- Kiali Viewer (для end-users/имперсонации) --------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kiali-viewer
rules:
- apiGroups: ["","apps","extensions","batch","autoscaling","networking.k8s.io","discovery.k8s.io","policy",
              "networking.istio.io","security.istio.io","telemetry.istio.io","gateway.networking.k8s.io"]
  resources: ["*"]
  verbs: ["get","list","watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kiali-viewer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kiali-viewer
subjects:
# Свяжите с вашей группой/профилем пользователей, если нужно, либо пропустите биндинг
- kind: Group
  name: kiali-viewers
  apiGroup: rbac.authorization.k8s.io

	3.	Перезапустите Kiali:

kubectl -n kiali rollout restart deploy/kiali
kubectl -n kiali logs deploy/kiali --since=2m

Увидите, что ошибки «forbidden … clusterrole … not found» ушли.

⸻

5) Частые ловушки
	•	cluster_wide_access: false при установке через server-chart: chart не сделает кластерные RBAC, и Kiali не увидит другие namespaces.
	•	rbac.create: false случайно попал из старого overlay.
	•	ArgoCD namespaced-only: любые ClusterRole/*Binding тихо проваливаются с forbidden. Смотрите события синка/логи контроллера.
	•	Создали роли вручную, но SA другое имя/namespace — проверьте subjects в ClusterRoleBinding.
	•	У вас несколько инстансов Kiali (канарейка) — у каждого свой SA/имя, создавайте для каждого binding.

⸻

6) Мини-проверка после фикса

# Должны существовать и быть привязаны:
kubectl get clusterrole kiali kiali-viewer
kubectl get clusterrolebinding | grep -E '\bkiali(-viewer)?\b'

# Под должен перейти в Running
kubectl -n kiali get pods -l app.kubernetes.io/name=kiali

# Kiali способен читать кросс-namespace:
kubectl -n kiali logs deploy/kiali | grep -i "forbidden" || echo "OK"

Если нужно, скидывай helm get values и имя SA ArgoCD — дам точный YAML под ваш сетап и (если хочешь) вариант с минимальными, а не «широкими», правилами для Kiali.
