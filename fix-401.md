Понял: **ни один из прошлых подходов проблему не снял** — и в тестовой, и в UAT среде одинаковые симптомы: после ввода логина/пароля в корпоративном CIDP в Kiali по-прежнему «OpenID authentication failed», в логах «session not found…», предупреждение про scopes и 401. Вы сейчас управляете Kiali **версии 2.5 через “голый” Deployment + ConfigMap** (не через Kiali Operator), и ваш текущий блок `auth:` в `config.yaml` фактически отключает OIDC (опечатка + пустой `openid`). Нужно перейти к *минимально рабочему*, строго валидному конфигу и дополнительно проверить цепочку сетевых и криптографических зависимостей, без которых OIDC просто не дойдёт до установки финальной cookie.

Ниже я дам:

1. **Минимальный рабочий конфиг для Kiali 2.5 с OpenID.**
2. **Полный пошаговый тестовый сценарий (“диагностический прогон”),** который по журналам и сетевым следам покажет, где ломается обмен (до /authorize, до /token, при проверке подписи, при установке cookie и т.д.).
3. **Расширенный список проверок инфраструктуры:** сетевой доступ, DNS, TLS-доверие, clock skew, Envoy sidecar, host/path rewriting, cookie domain, scopes, issuer match и др.
4. Ответ на ваш прямой вопрос: **Redirect URI в ConfigMap Kiali не задаётся вручную; Kiali формирует его сам.** Нужно, чтобы *тот URL, который он формирует*, был зарегистрирован в CIDP.
5. Что собрать и прислать, если после всех проверок ошибка останется — чтобы мы могли “диагностировать по данным”.

---

# 1. Минимальный рабочий `config.yaml` для Kiali 2.5 (Deployment + ConfigMap)

> **Важно:** удалите лишние / неверные ключи (`atrategy`, `openshift`, пустые `openid: {}` и т.п.). Kiali парсит YAML строго: неизвестные ключи игнорирует, но из-за опечатки `atrategy` вы фактически работали в fallback-режиме *anonymous*.

```yaml
# ConfigMap: kiali-configuration  (ключ: config.yaml)
server:
  web_root: "/kiali"                   # без завершающего слэша
  web_schema: "https"                  # критично: формирует redirect_uri
  web_fqdn: "kiali.intranet.corp.com"  # критично: формирует redirect_uri
  cluster_name: "db-dev-kli6-uk-cluster-01"  # имя в cookie

auth:
  strategy: openid
  openid:
    issuer_uri: "https://cidp.corp.com/realms/corp"   # точное значение 'iss'
    client_id: "kiali"                                # ваш ClientID
    # client_secret НЕ пишем здесь — берётся из k8s Secret (см. ниже)
    scopes:
      - openid
      - email
    # Пока отлаживаем — отключим попытки K8s RBAC-проверок:
    disable_rbac: true
```

**Секрет с client secret:**

```bash
kubectl -n istio-system create secret generic kiali \
  --from-literal=oidc-secret='<ВАШ_CLIENT_SECRET>' \
  --dry-run=client -o yaml | kubectl apply -f -
```

(Используйте `--from-literal`, чтобы не затянуть `\n` в конец значения.)

**Перезапуск:**

```bash
kubectl rollout restart deploy/kiali -n istio-system
```

---

# 2. Куда Kiali *реально* редиректит (Redirect URI)

В Kiali 2.5 поведение следующее:

* Он строит **базовый публичный URL** из `server.web_schema` + `server.web_fqdn` + `server.web_root`.
* Туда добавляет внутренний путь завершения OIDC-обмена (в ветках 1.x это было `/kiali`, в более новых — `/kiali/api/oidc/login`; в 2.5 нужно проверить фактический Location в браузере).
* Именно *это значение* он посылает в параметре `redirect_uri` на ваш CIDP.

**Вывод:** *Отдельного поля “redirect\_uri” в config.yaml нет и не нужно.* Чтобы изменить redirect\_uri, вы меняете `web_root` / `web_fqdn` / `web_schema`.
Попросите коллег в CIDP-команде показать список разрешённых redirect-URI для вашего клиента — один из них должен *в точности* совпадать с тем, что вы реально видите в браузере в запросе `/authorize?...redirect_uri=...`.

---

# 3. Диагностический прогон (пошагово)

Давайте локализуем точку отказа. Сделайте всё в такой последовательности и сообщите, на каком шаге картина расходится.

---

## 3.1 Подготовка

**Очистите браузерные cookie** для домена `kiali.intranet.corp.com` (чтобы не мешали старые nonce).

**Включите debug-логирование в Kiali Pod** (в 2.5 можно через env или аргумент запуска; если неудобно перестраивать, смотрим то, что есть).

---

## 3.2 Стартовая загрузка UI

1. Откройте: `https://kiali.intranet.corp.com/kiali` (или `/kiali/` — важно понять, на что редиректит ingress).
2. В DevTools → Network найдите **первый ответ Kiali**. Он должен содержать HTML с кнопкой / редиректом на авторизацию.

**Ожидаемо:** Kiali ставит *временную nonce-cookie* `kiali-token-nonce-...` (по Path `/kiali` или `/`). Если её нет — значит даже UI-страница не верно загружена.

---

## 3.3 Переход на CIDP

3. Вы нажимаете "Login" → идёт redirect на CIDP `/authorize?...redirect_uri=...`.
   Скопируйте из адресной строки полный URL (нам важен `redirect_uri=`).

Проверьте:

* Совпадает ли host/схема/путь с тем, что вы зарегистрировали в CIDP?
* Есть ли URL-encoding (например `%2Fkiali%2Fapi%2Foidc%2Flogin`)? В регистрациях иногда забывают слэш на конце.

---

## 3.4 Ввод логина/пароля (CIDP)

4. После аутентификации CIDP делает redirect **назад на redirect\_uri** с параметрами `code=...&state=...`.
   В DevTools найдите *этот* запрос (должен прийти на ваш Ingress → Kiali).

* **HTTP статус?** 200 / 302 / 401?
* **Есть ли в ответе заголовок `Set-Cookie: kiali-token-...`?** (главное — без `-nonce-`.)
* В Path этого заголовка что указано? `/kiali` или `/`?

Если **нет `Set-Cookie` с токеном**, Kiali не смог обменять код на токен → идём к разделу 4 (ошибки обмена код → токен).

---

## 3.5 После редиректа к UI

5. Браузер возвращается на UI и делает XHR-запросы (`/kiali/api/...`).
   В вкладке Application → Cookies должны присутствовать:

   * `kiali-token-nonce-...` (вскоре исчезнет/истечёт)
   * `kiali-token-...` **рабочий** (Expires > текущего времени).

Если рабочей cookie нет — сервер её не установил или прокси срезал заголовок.

---

# 4. Если Kiali *не* устанавливает токен-cookie (корневые причины)

Проверяем следующие вещи **изнутри Pod Kiali** (exec shell в pod):

---

## 4.1 Сетевой доступ к точкам OIDC

```bash
CIDP_BASE="https://cidp.corp.com/realms/corp"
for u in \
  "$CIDP_BASE/.well-known/openid-configuration" \
  "$CIDP_BASE/protocol/openid-connect/auth" \
  "$CIDP_BASE/protocol/openid-connect/token" \
  "$CIDP_BASE/protocol/openid-connect/certs"
do
  echo "== $u"
  curl -vk --connect-timeout 5 "$u" | head -n 2
done
```

**Ожидаемо:** все четыре запроса TCP-доступны и завершаются 200 (или 302/JSON).
Если нет доступа → OIDC не сможет обменять код на токен → нет cookie → ваша ошибка.

---

## 4.2 TLS доверие

Если curl показывает `SSL certificate problem: unable to get local issuer certificate`, контейнер Kiali не доверяет корпоративному корневому CA. Нужно:

* Смонтировать trust bundle в контейнер;
* Или использовать системный trust store, куда включён ваш CA.

Без доверия TLS-рукопожатие к `/token` / `/certs` не пройдёт → Kiali не получит ключей для подписи → OpenID auth failed.

---

## 4.3 Проверка discovery и scopes

Скачайте discovery JSON:

```bash
curl -s "$CIDP_BASE/.well-known/openid-configuration" | jq .
```

Сравните `issuer` с вашим `issuer_uri` (должны совпадать **побайтно**, включая слэш): любое расхождение = отказ верификации токена.

Смотрите `scopes_supported`. Разрешено ли `email`? Если нет — уберите из `scopes` в конфиге.

---

## 4.4 Проверка client\_id / secret

Проверьте, что секрет прочитан Kiali Pod’ом:

```bash
kubectl -n istio-system get secret kiali -o jsonpath='{.data.oidc-secret}' | base64 -d; echo
```

Сравните с тем, что выдали коллеги.

---

## 4.5 Clock skew

Посмотрите системное время в Pod и сравните с реальным временем IdP (можно curl `/token`, посмотреть `iat`/`exp` в ID-токене). Разбег >5 мин может дать «token expired / issued in future» → Kiali посчитает токен недействительным и не создаст cookie.

---

# 5. Интеграция с Istio Ingress (Path / Cookie)

Поскольку у вас префикс `/kiali`, убедитесь:

* Ingress / Gateway / VirtualService **не делает дополнительного rewrite**, добавляющего или убирающего слэш.
* Cookie с токеном в ответе от Kiali имеет `Path=/kiali`; если она приходит как `/`, но ваши запросы идут на `/kiali/...`, браузер может не вернуть cookie (зависит от браузера и контекста).
* Если вы оставляете Path `/`, можно настроить VirtualService rewrite на `/` внутрь сервиса (тогда web\_root в конфиге менять на `/`).

---

# 6. Расширенные параметры, которые *можно* добавить в Kiali 2.5

Хотя 2.5 ещё не имела полного набора cookie-атрибутов, кое-что можно:

| Параметр                                                       | Где                             | Назначение                                        | Примечание                                       |
| -------------------------------------------------------------- | ------------------------------- | ------------------------------------------------- | ------------------------------------------------ |
| `auth.openid.disable_rbac`                                     | ConfigMap                       | Обход запроса в K8s API; полезно при отладке      | true на время диагностики                        |
| `auth.openid.insecure_skip_verify_tls` *(если доступен в 2.5)* | Мог быть флагом в ранних ветках | Позволяет игнорировать TLS цепочку (временно!)    | Использовать только для теста; лучше починить CA |
| `server.metrics_enabled`                                       | Info                            | Для мониторинга; косвенно полезно видеть здоровье | Не влияет на вход                                |

Если в вашей конкретной сборке 2.5 нет поля skip-verify, тогда обязательно чинить доверие CA.

---

# 7. Что прислать, чтобы я смог точнее подсказать

Пожалуйста скопируй/вставь (чувствительные значения замажь `***`):

1. **Текущий `config.yaml` из ConfigMap\`** (актуальная версия после исправлений).
2. **Вывод:**

   ```bash
   kubectl -n istio-system get secret kiali -o yaml
   ```

   (Можешь скрыть base64-значение, главное — имя ключа.)
3. **Фрагмент браузерного Network-лога:** запрос к CIDP с `redirect_uri=...` и ответ с кодом.
4. **Фрагмент ответа, который возвращается по этому redirect обратно на Kiali** (заголовки `Set-Cookie`).
5. **Первые \~50 строк логов Kiali Pod после попытки логина**.
6. Результат curl’ов к эндпоинтам CIDP изнутри Pod (см. выше).

С этими данными мы найдём точный узел.

---

# 8. Ответы на конкретные ваши вопросы

**> Нужен ли Redirect URI в ConfigMap Kiali?**
Нет. Kiali вычисляет redirect URI сам из `web_schema`, `web_fqdn`, `web_root` (и своего внутреннего пути). Вручную задавать нельзя; нужно зарегистрировать *тот* URL в CIDP.

**> Почему изменение Redirect URI в config.yaml “не влияет”?**
Потому что вы не меняли поля, из которых он строится (или была опечатка в ключе). Либо Deployment не перечитал ConfigMap (нет рестарта).

**> Может ли отсутствие сетевого доступа ломать?**
Да. Если Pod не достаёт `/token`, он не обменяет код → не поставит токен-cookie → «OpenID authentication failed».

**> Почему в браузере только `kiali-token-nonce-...`?**
Это пред-OIDC cookie. Значит, вы дошли до шага 3, но сломались на шаге обмена код → токен или на установке финальной cookie.

---

# 9. Минимальный “Smoke Test” (скрипт внутри Pod)

Можно прямо в Pod Kiali (или во временном debug-pod’e) выполнить и прислать вывод:

```bash
#!/usr/bin/env bash
set -euo pipefail
CIDP="https://cidp.corp.com/realms/corp"
echo "[1] Discovery:"
curl -sk -o /tmp/discovery.json "$CIDP/.well-known/openid-configuration" || echo "!! fail"
jq -r '.issuer, .authorization_endpoint, .token_endpoint, .jwks_uri' /tmp/discovery.json

echo "[2] TLS test token endpoint:"
curl -vk "$CIDP/protocol/openid-connect/token" -o /dev/null

echo "[3] Time sync:"
echo "Pod time: $(date -u +%s) ($(date -u))"
echo "CIDP Date header:"
curl -sI "$CIDP" | grep -i '^Date:'
```

---

## Заключение

Сейчас корневая проблема почти наверняка *в одном из трёх мест*:

1. **Kiali не в режиме OpenID** (из-за опечатки / неправильного блока `auth:`).
2. **Неудачный обмен код → токен** (сеть, TLS, issuer mismatch, scopes, client\_secret).
3. **Финальная cookie с токеном не доходит до браузера** (Ingress/Path/перезапись заголовков).

Приведите конфиг к минимальному рабочему примеру, проверьте сетевой доступ и discovery, зафиксируйте redirect\_uri, и мы сможем точно указать, что ломается. Пришлите результаты шагов из раздела 7 — продолжим разбор до победы.

---

**Хочешь — давай сделаем вместе прямо сейчас:** скинь свежий `config.yaml` и Network-трейс авторизации; я по диффу скажу, что поправить первым делом.
