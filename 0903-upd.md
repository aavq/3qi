Окей, Löscha — давай сделаем апгрейд «по-взрослому»: с чек-листами, маппингом ключей, примерами values/ConfigMap, командами для ArgoCD и тестами. Сразу отвечу на главный вопрос: **нет, просто поменять image недостаточно.** Между 2.5.x и 2.14/2.15 произошли важные изменения, которые требуют правки конфигурации.

> Примечание про версии: на сегодня (02 сентября 2025) самые свежие публичные релиз-ноты — до **2.14.0**. Про **2.15.0** отдельных заметок пока нет. Поэтому ниже — “миграция 2.5.0 → 2.14.x (и выше)”; для 2.15 ориентируемся на те же правила и перед выкладкой смотрим релиз-ноты на kiali.io. ([kiali.io][1])

# Что изменилось (и почему просто смена image не сработает)

1. **Namespace management:**
   исторические настройки `deployment.accessible_namespaces`, `api.namespaces.include/exclude/label_selector_*` **удалены** в Kiali v2 и заменены на **Discovery Selectors** (`deployment.discovery_selectors`). Это breaking change c 2.0. ([kiali.io][2])

2. **URLs внешних сервисов переименованы:**
   `external_services.*.(in_cluster_url|url)` → теперь **`internal_url`** и **`external_url`** для Grafana и Tracing (Jaeger/Tempo). Изменение пришло в v2.0 и актуально дальше. ([Medium][3])

3. **Граф Cytoscape удалён:**
   после периода деприкации в 2.8 поддержка старого графа снята. Параметр `kiali_feature_flags.ui_defaults.graph.impl` больше не поддерживается (остаётся PatternFly Topology). Если он у тебя задан — удалить. ([kiali.io][2])

4. **Istio labels поведения по умолчанию менялись:**
   начиная с 2.6 дефолты для app/version лейблов стали «не заданы» (для смешанных схем меток). Если ты явно настраивал `istio_labels`, оставь осознанно, иначе удали — Kiali сам подстроится. (см. релиз-ноты серии 2.x) ([kiali.io][1])

5. **Auto-discovery Istio и прочее упрощение конфигурации (2.14):**
   часть полей больше не требуется/устарела — например, автоопределяются данные Istio; удалены `spec.istio_namespace`, `spec.in_cluster`, `spec.deployment.remote_secret_path`, а также избыточные поля под `external_services.istio.*`. Если такие ключи есть — убрать.

6. **OpenID только по “Authorization Code Flow”:**
   Implicit flow давным-давно деприкейтнули и он ещё и уязвим (CVE-2021-20278). Для `auth.strategy: openid` нужна корректная конфигурация Code Flow. ([kiali.io][4])

7. **Совместимость с Istio:**
   проверь матрицу: Istio **1.25** поддерживается Kiali **2.5+**, Istio **1.26** — **2.9+**, **1.27** — **2.12+**. Если ты идёшь на 2.14 — ок с 1.25–1.27. ([kiali.io][5])

8. **Server Helm Chart vs Operator:**
   ты ставишь **без оператора**. Тогда **Roles/RBAC под discovery selectors Helm-чарт не создаёт** — либо включай `deployment.cluster_wide_access: true`, либо готовь RBAC сам. Это важный нюанс. ([kiali.io][6])

9. **`server.web_root` и путь `/kiali`:**
   Kiali обслуживает UI и API с базового пути `web_root` (по умолчанию `/kiali` на Kubernetes). Трейлинг-слэшей быть не должно. Все проверки/ingress-маршруты должны соответствовать этому префиксу. ([kiali.io][7])

---

# План обновления (Helm/ArgoCD)

## 0) Предварительные проверки

* Сверь версию Istio с матрицей совместимости. ([kiali.io][5])
* Зафиксируй текущие значения:

  ```bash
  kubectl -n istio-system get cm kiali -o yaml > kiali-config-before.yaml
  kubectl -n istio-system get deploy,sa,svc,ing,gw,vs | grep kiali || true
  ```
* Проверь доступность Prometheus/Tracing/Grafana адресов, которыми ты кормишь Kiali (curl из под busybox в кластере). ([kiali.io][8])
* Если используешь OIDC — подтверди, что это **authorization code flow**, и у тебя заведён секрет с client\_secret. ([kiali.io][4])

## 1) Маппинг ключей (старые → новые)

| Что было                                                                                                           | Что стало / Действие                                                                     |                                                                        |
| ------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `deployment.accessible_namespaces`                                                                                 | **Удалить.** Использовать `deployment.discovery_selectors`. ([kiali.io][2])              |                                                                        |
| `api.namespaces.include/exclude`                                                                                   | **Удалить.** Логику перенести в discovery selectors (по label-selector). ([kiali.io][2]) |                                                                        |
| \`api.namespaces.label\_selector\_(include                                                                         | exclude)\`                                                                               | **Удалить.** Вся фильтрация через discovery selectors. ([kiali.io][2]) |
| `external_services.grafana.url`                                                                                    | `external_services.grafana.external_url`                                                 |                                                                        |
| `external_services.grafana.in_cluster_url`                                                                         | `external_services.grafana.internal_url`                                                 |                                                                        |
| `external_services.tracing.url`                                                                                    | `external_services.tracing.external_url`                                                 |                                                                        |
| `external_services.tracing.in_cluster_url`                                                                         | `external_services.tracing.internal_url` ([Medium][3])                                   |                                                                        |
| `kiali_feature_flags.ui_defaults.graph.impl`                                                                       | **Удалить.** Cytoscape больше не поддерживается. ([kiali.io][2])                         |                                                                        |
| `spec.istio_namespace`, `spec.in_cluster`, `spec.deployment.remote_secret_path`, часть `external_services.istio.*` | **Удалить.** Авто-дискавери в 2.14.                                                      |                                                                        |

> Если ставишь **Server Helm Chart** (без оператора) и хочешь ограничить области видимости по namespace, либо включай `deployment.cluster_wide_access: true`, либо сам клади RBAC для каждой цели. Иначе Kiali просто не увидит нужные неймспейсы. ([kiali.io][6])

## 2) Пример актуального `values.yaml` (Helm kiali/kiali-server)

> Этот файл следует коммитить в Git-репозиторий ArgoCD и пиновать версию чарта.

```yaml
# kiali-server values.yaml (для 2.14.x/2.15.x)
deployment:
  # Для helm-установки без оператора чаще всего включают cluster-wide доступ.
  cluster_wide_access: true
  # (опционально) имя инстанса, если хочешь катить «канарейку» параллельно
  instance_name: kiali
  # (опционально) задержки проб (в 2.x сделали настраиваемыми)
  # readiness_probe: { initialDelaySeconds: 10 }
  # liveness_probe:  { initialDelaySeconds: 10 }

server:
  web_root: /kiali        # путь без трейлинг-слэша
  # web_schema/web_port/web_fqdn — только если ингресс/прокси неверно пробрасывают заголовки
  # web_schema: https
  # web_port: "443"

auth:
  strategy: openid        # или token/anonymous/...
  openid:
    issuer_uri: "https://<your-idp>/.well-known/openid-configuration"
    client_id: "<client_id>"
    # client_secret берётся из секрета (см. ниже)
    # Скоупы по умолчанию: openid,profile,email; можно расширять
    scopes: ["openid","profile","email"]
    username_claim: "preferred_username"
    # authentication_timeout, insecure_skip_verify_tls — по ситуации

login_token:
  # срок действия сессии (только для token/header стратегий, см. доку)
  expiration_seconds: 86400

external_services:
  prometheus:
    # Явно укажи URL, если Prometheus не стандартный:
    url: "http://prometheus.monitoring.svc.cluster.local:9090"
    # (опционально) health_check_url если стандартный UI отсутствует
    # health_check_url: "http://prometheus.monitoring.svc.cluster.local:9090/-/healthy"
  grafana:
    enabled: true
    internal_url: "http://grafana.monitoring.svc.cluster.local"
    external_url: "https://grafana.example.com"
  tracing:
    enabled: true
    # Если Jaeger:
    use_grpc: true
    internal_url: "http://jaeger-query.jaeger.svc.cluster.local:16685/jaeger"
    external_url: "https://jaeger.example.com"
    # Если Tempo — аналогично, без /jaeger, см. доки по Tempo.

# Discovery selectors — работают «как в Istio», но без оператора helм-чарт роли не создаёт.
# Если НЕ включен cluster_wide_access: true, то нужны собственные RBAC.
deployment:
  discovery_selectors:
    default:
      - matchExpressions:
          - key: kiali.io/member-of
            operator: In
            values: ["platform","payments"]
```

Ссылки по ключам: discovery selectors, web\_root, Prometheus/Tracing/Grafana, OIDC. ([kiali.io][7])

### Секреты для OIDC/паролей (без оператора)

Рекомендуемый способ — **монтировать кастомные секреты** и ссылаться на них в values (Helm-паттерн у Kiali готов):

```yaml
deployment:
  custom_secrets:
    - name: "kiali-oidc"
      mount: "/kiali-override-secrets/oidc"
auth:
  openid:
    client_secret: "secret:kiali-oidc:client_secret.txt"
```

И создать секрет:

```bash
kubectl -n istio-system create secret generic kiali-oidc \
  --from-literal=client_secret.txt='<client_secret>'
```

Kiali увидит: `Credentials loaded from secret file [/kiali-override-secrets/oidc/client_secret.txt]`. ([kiali.io][9])

## 3) Если у тебя конфиг через **ConfigMap** (а не только values)

Нужное содержимое ключа `config.yaml` в `ConfigMap/kiali` будет логически соответствовать values выше. Главное:

* **Удалить** `deployment.accessible_namespaces`, `api.namespaces.*`, `kiali_feature_flags.ui_defaults.graph.impl`, устаревшие `external_services.*.(url|in_cluster_url)` и всё из блока, который релиз-ноты 2.14 считают автодискаверимым. ([kiali.io][2], [Medium][3])
* **Добавить** `deployment.discovery_selectors` (если не даёшь cluster-wide), **переименованные** `internal_url/external_url`, проверить `server.web_root`.

> Замечание: в официальной доке про CR пишут «не редактируйте ConfigMap руками — оператор его перетрёт», но у тебя **оператора нет**, конфиг управляет Helm/ArgoCD — редактируем манифест под твой способ доставки. ([kiali.io][10])

## 4) Обновление через ArgoCD

**Вариант безопасного «канареечного» апгрейда** (рекомендую):

1. Создай **второй инстанс** Kiali:

   * `deployment.instance_name: kiali-canary`
   * `server.web_root: /kiali-canary`
   * отдельный Service/Ingress (будут с префиксом имени инстанса).
2. Применяй новые values/ConfigMap к канарейке (`targetRevision` нужного чарта), дождись `Healthy/Synced`.
3. Прогоняй проверки (ниже). Если всё ок — переводи пользователей/линки на `/kiali-canary` и **вторым коммитом** обновляй основной инстанс.
4. После стабилизации — удаляй канареечного.

**Минимальный ArgoCD Application (фрагмент):**

```yaml
spec:
  source:
    repoURL: https://kiali.org/helm-charts
    chart: kiali-server
    targetRevision: 2.14.*           # зафиксируй минор/патч под себя
    helm:
      valueFiles:
        - kiali/values.yaml
  destination:
    namespace: istio-system
    server: https://kubernetes.default.svc
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

(Как подобрать версию чарта: `helm repo add kiali https://kiali.org/helm-charts && helm repo update && helm search repo kiali/kiali-server --versions`)

## 5) Чек-лист тестов после апгрейда

* **Доступность UI и базового пути:**

  ```bash
  kubectl -n istio-system port-forward svc/kiali 20001:20001
  curl -I http://127.0.0.1:20001/kiali        # 200/302
  curl -s http://127.0.0.1:20001/kiali/api    # 401 (если auth включен) — это нормально
  ```

  Убедись, что все Ingress/Gateway/VirtualService матчат **`/kiali`** без трейлинг-слэша. ([kiali.io][7])

* **OIDC-логин** (если включён): редирект в IdP, возврат по callback, появление имени пользователя в UI. Помним: поддерживается только **authorization code flow**. ([kiali.io][4])

* **Prometheus:**

  * Графы и health в Kiali заполняются → ОК.
  * Если Prometheus UI отсутствует — настроить `health_check_url` (иначе Kiali может показывать «unreachable», хотя запросы работают). ([kiali.io][11], [GitHub][12])

* **Tracing (Jaeger/Tempo):**

  * Для Jaeger с gRPC — `use_grpc: true` и правильный `:16685/jaeger`. Для Tempo — см. гайд (интеграция и datasource). ([kiali.io][13])

* **Граф:** убедись, что граф рисуется без ошибок — параметр `impl` больше не поддерживается (если забыли удалить). ([kiali.io][2])

* **RBAC/Discovery:** зайди под пользователем с ограниченным доступом и проверь список доступных неймспейсов — он должен соответствовать твоим `discovery_selectors`+RBAC. При установке **без оператора** селекторы сами роли не создают. ([kiali.io][6])

* **Проверка логов Kiali:** отсутствие ошибок `Prometheus unreachable`, `Tracing disabled`, `oidc ... error`, `session not found` и пр.

## 6) Типовые проблемы и как чинить

* **404 на `/kiali/api/...` через ingress, а через `port-forward` всё ок** — проверь правила маршрутизации по префиксу: должны быть **оба**: `/kiali` и `/kiali/` (или правильно настроенный prefix/pathRewrite). И не делай `HEAD` на некоторые API — используем `GET`. (Общая рекомендация из практики + специфика web\_root). ([kiali.io][14])

* **Не появились нужные неймспейсы** — при helm-установке без оператора либо:

  1. включи `cluster_wide_access: true`, либо
  2. создай необходимые Role/RoleBinding/ClusterRole вручную под свой селектор. ([kiali.io][6])

* **Grafana/Tracing адреса не подхватились** — проверь переименование полей на `internal_url`/`external_url`. Старые ключи игнорируются. ([Medium][3])

* **OIDC отваливается/циклический редирект** — проверь, что у IdP включён code flow, корректен `issuer_uri`, совпадает `web_root` в redirect URI, верен `client_secret` (через mounted secret). ([kiali.io][4])

* **Prometheus “unreachable”, графы работают** — добавь `health_check_url` на `/-/healthy`. ([kiali.io][11], [GitHub][12])

---

# Быстрый шаблон миграции (diff-стратегия)

1. В values/ConfigMap **удали**:

```
deployment:
  accessible_namespaces: ...
api:
  namespaces:
    include: ...
    exclude: ...
    label_selector_include: ...
    label_selector_exclude: ...
kiali_feature_flags:
  ui_defaults:
    graph:
      impl: ...
external_services:
  grafana:
    url: ...
    in_cluster_url: ...
  tracing:
    url: ...
    in_cluster_url: ...
# а также spec.istio_namespace/in_cluster/remote_secret_path если встречаются
```

2. **Добавь/переименуй**:

```
deployment:
  cluster_wide_access: true   # или discovery_selectors + свои RBAC
  discovery_selectors:
    default:
      - matchLabels: { kiali.io/member-of: platform }
server:
  web_root: /kiali
external_services:
  grafana:
    internal_url: http://grafana.monitoring.svc.cluster.local
    external_url: https://grafana.example.com
  tracing:
    enabled: true
    use_grpc: true
    internal_url: http://jaeger-query.jaeger.svc.cluster.local:16685/jaeger
    external_url: https://jaeger.example.com
  prometheus:
    url: http://prometheus.monitoring.svc.cluster.local:9090
auth:
  strategy: openid
  openid:
    issuer_uri: https://<idp>/.well-known/openid-configuration
    client_id: <id>
    scopes: ["openid","profile","email"]
    # client_secret: "secret:kiali-oidc:client_secret.txt"
```

---

# Роллбек

* В ArgoCD верни `targetRevision` на предыдущий чарт или откати коммит с values/ConfigMap.
* Pod/ReplicaSet Kiali stateless — откат быстрый.

---

# Полезные ссылки (ключевые моменты)

* Release notes (2.5–2.14), в т.ч. про удаление Cytoscape и автодискавери в 2.14. ([kiali.io][1])
* Namespace Management и нюансы helm-установки без оператора. ([kiali.io][6])
* Пререквизиты и матрица Kiali↔Istio. ([kiali.io][5])
* OpenID (только Authorization Code Flow) + уязвимость implicit flow. ([kiali.io][4])
* Переименование `url`→`external_url` и `in_cluster_url`→`internal_url`. ([Medium][3])
* Настройка Prometheus/Tracing/Grafana (Tempo/Jaeger). ([kiali.io][8])
* Helm-установка/обновление и работа с секретами во values. ([kiali.io][10])
* `server.web_root` и правила маршрутизации. ([kiali.io][7])

---

Хочешь — в следующем шаге сделаю **точный diff** по твоему текущему ConfigMap/values и приготовлю готовую ArgoCD-ветку “канареечного” деплоя (с `/kiali-canary`) + чек-скрипты для smoke-тестов.

[1]: https://kiali.io/news/release-notes/ "Release Notes | Kiali"
[2]: https://kiali.io/news/release-notes/?utm_source=chatgpt.com "Release Notes"
[3]: https://medium.com/kialiproject/kiali-2-0-for-istio-2087810f337e "Kiali 2.0 for Istio. It’s been seven+ years and Istio… | by Jay Shaughnessy | Kiali | Medium"
[4]: https://kiali.io/docs/configuration/authentication/openid/?utm_source=chatgpt.com "OpenID Connect strategy"
[5]: https://kiali.io/docs/installation/installation-guide/prerequisites/?utm_source=chatgpt.com "Prerequisites"
[6]: https://kiali.io/docs/configuration/namespace-management/?utm_source=chatgpt.com "Namespace Management"
[7]: https://kiali.io/docs/configuration/kialis.kiali.io/?utm_source=chatgpt.com "Kiali CR Reference"
[8]: https://kiali.io/docs/configuration/p8s-jaeger-grafana/prometheus/?utm_source=chatgpt.com "Prometheus"
[9]: https://kiali.io/docs/faq/installation/?utm_source=chatgpt.com "Installation"
[10]: https://kiali.io/docs/installation/installation-guide/install-with-helm/?utm_source=chatgpt.com "Install via Helm"
[11]: https://kiali.io/docs/faq/istio-component-status/?utm_source=chatgpt.com "Istio Component Status"
[12]: https://github.com/kiali/kiali/issues/6966?utm_source=chatgpt.com "use the Prometheus `/-/healthy` endpoint for the default ..."
[13]: https://kiali.io/docs/configuration/p8s-jaeger-grafana/tracing/jaeger/ "Jaeger | Kiali"
[14]: https://kiali.io/docs/installation/installation-guide/accessing-kiali/?utm_source=chatgpt.com "Accessing Kiali"
