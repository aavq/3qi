**В двух словах**: скрипт выполняется внутри HTTP-Lua-фильтра Envoy на каждом входящем запросе. Он достаёт из TLS-рукопожатия имя клиента (сначала SAN→DNS, потом CN), вписывает его в новый заголовок `x-client-cn`, предварительно удалив возможный поддельный заголовок, и выводит предупреждение, если сертификата нет. Это упрощает авторизацию и трассировку запросов “за” шлюзом, не требуя, чтобы все сервисы сами умели читать mTLS-сертификаты. Ниже — подробный разбор пошагово.

---

## 1  Где и когда выполняется код

* **Lua-фильтр Envoy** работает в рамках HTTP-конвейера; функция `envoy_on_request()` вызывается сразу после получения заголовков и до маршрутизации запроса citeturn0search0.  
* Фильтр встраивается в **Istio EnvoyFilter** с `applyTo: HTTP_FILTER`, поэтому код видит те же заголовки, что и остальные HTTP-фильтры, и может менять их до выхода к бэкенду citeturn0search3.  

---

## 2  Разбор кода по строкам

| Строка | Что делает | Подробности API |
|--------|------------|-----------------|
| `handle:headers():remove("x-client-cn")` | Стирает входящий заголовок, чтобы клиент не смог подменить значение. | Метод `remove()` доступен на коллекции заголовков citeturn1search0 |
| `local ssl = handle:connection():ssl()` | Получает объект TLS-сессии; вернёт `nil`, если соединение не защищено. | `connection():ssl()` возвращает wrapper SSL-объекта citeturn6search0turn4search2 |
| `ssl and ssl:peerCertificatePresented()` | Быстро проверяет, прислал ли клиент сертификат. | Метод объявлен в исходниках как `peerCertificatePresented()` citeturn0search6 |
| `ssl:dnsSansPeerCertificate()` | Берёт массив DNS-имён из SAN; если он непустой — используем первый элемент. | Описание метода в доках citeturn0search1 |
| `ssl:parsedSubjectPeerCertificate():commonName()` | Fallback: разбирает Subject и возвращает CN. | `parsedSubjectPeerCertificate()` и `commonName()` описаны в API Lua SSL wrapper citeturn6search0 |
| `handle:headers():replace("x-client-cn", client_cn)` | Записывает итоговое значение заголовка, гарантируя, что он присутствует ровно один раз. | `replace()` приведён в примере официальных доков (Lua-фильтр меняет `content-type`) citeturn5search0 |
| `handle:logWarn(...)` | Пишет предупреждение в логи Envoy, если клиент пришёл без сертификата. | Все объекты Lua-API поддерживают `logWarn()` citeturn3search0 |

---

## 3  Почему сначала SAN, а потом CN

* RFC 2818 прямо говорит, что использование **Common Name устарело**; авторы сертификатов должны помещать идентификатор в SubjectAltName citeturn0search2.  
* Поэтому скрипт сначала смотрит `dnsSansPeerCertificate()`, а к CN обращается только для обратной совместимости.

---

## 4  Безопасность и надёжность

1. **Спуфинг заголовка**: удаление/замена гарантирует, что приложение downstream видит только проверенное значение. В противном случае злоумышленник мог бы прислать свой `x-client-cn`.  
2. **mTLS обязателен**: если Gateway сконфигурирован в режиме `MUTUAL`, Envoy разрывает соединение, когда не может проверить цепочку CA; фильтр же увидит `no-cert`, и вы сможете отреагировать на это внутри бизнес-логики.  
3. **Логирование** через `logWarn()` фиксирует аномалии и позволяет строить алерты без дополнительного кода.  

---

## 5  Потоки данных после фильтра

```text
Клиент (mTLS) ─▶ Envoy Ingress │Lua пишет x-client-cn│ ─▶ Сервис-A
                                                       │           └─▶ downstream-сервисы
```

* Сервис-A теперь получает HTTP-заголовок `x-client-cn` и может решать,      например, какие разрешения дать пользователю.  
* Значение доступно и в логах/метриках самого Envoy, если вы включите их в формат access-log.  

---

## 6  Что можно расширить

| Идея | Как сделать |
|------|-------------|
| **Метрика Prometheus** по запросам без сертификата | `handle:counter("missing_peer_cert"):increment(1)` citeturn4search3 |
| **Добавить проверку валидации** | Вместо `peerCertificatePresented()` вызвать `peerCertificateValidated()`, чтобы убедиться, что цепочка прошла CA-проверку citeturn6search0 |
| **Обогащать dynamic metadata** | `handle:streamInfo():dynamicMetadata():set("auth", "cn", client_cn)` — можно читать в других фильтрах без заголовков citeturn6search0 |
| **Управляемый порядок фильтров** | В Istio фильтр вставляют `INSERT_BEFORE`/`priority`, чтобы он шёл сразу перед Router citeturn0search18 |

---

## 7  Ключевые выводы

* Скрипт превращает mTLS-атрибут (CN/SAN) в обычный HTTP-заголовок, снимая с микросервисов обязанность анализировать сертификаты.  
* Он делает это безопасно: очищает возможные подделки, отдаёт предпочтение SAN и сигнализирует о запросах без сертификата.  
* Реализован на поддерживаемых методах Lua-API Envoy, которые задокументированы и стабильны.  

Теперь у вас под рукой надёжный базовый шаблон; при нужде его легко дополнить валидацией, метриками или переходом на AttributeGen/Wasm без изменения логики.
